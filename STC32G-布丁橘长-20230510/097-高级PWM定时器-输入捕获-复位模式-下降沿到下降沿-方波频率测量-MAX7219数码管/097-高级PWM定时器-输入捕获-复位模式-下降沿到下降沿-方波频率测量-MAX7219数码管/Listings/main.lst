C251 COMPILER V5.57.0,  main                                                               15/03/23  21:09:12  PAGE 1   


C251 COMPILER V5.57.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\SoftWare\KeilC251\C251\BIN\C251.EXE main.c XSMALL BROWSE DEBUG PRINT(.\Listings\main.lst) TABS(2
                    -) OBJECT(.\Objects\main.obj) 

stmt  level    source

    1          //  @ٳ 2023/03/14
    2          //  PWM벶ʾλģʽ½ص½أȡֵƵʣMAX7219ʾ
    3          //  PWM5(P2.0)Ĭ500Hz ռձ50%
    4          //  MAX7219ģŶ壺CS = P6^5;DIN = P6^6;CLK = P6^4;MAX7219.h޸ģ
    5          //  ʵ鿪壺.1 @Ƶ12MHz
    6          
    7          #include "stc32g.h"
    8          #include "config.h"
    9          #include "MAX7219.h"
   10          
   11          #define PWMB_PSC (12 - 1)     // 12Ƶʱ1us
   12          #define PWMB_PERIOD_500 2000  // 2룬500Hz
   13          #define PWMB_PERIOD_1K 1000   // 1룬1KHz    
   14          #define PWMB_PERIOD_2K 500    // 500us2KHz
   15          #define PWMB_PERIOD_5K 200    // 200us5KHz
   16          
   17          sbit KEY1 = P3^2;             // ذP3.2
   18          sbit KEY2 = P3^3;             // ذP3.3
   19          
   20          void SYS_Ini();               // STC32ʼ
   21          void SEG_Disp(void);          // ʾ
   22          void PWM_Config();            // PWMʼ
   23          void Timer0_Init(void);       // ʱ0ʼ
   24          void keyscan();               // ɨ
   25          
   26          int cap;                      // ֵ
   27          long int freq;                // Ƶ
   28          u8 segdelay;                  // ʱ
   29          bit B_1ms;                    // 1msʱ־
   30          u8 key1delay,key2delay;       // 12ʱ
   31          u16 period;                   // PWM
   32          u8 number;                    // PWMڶӦֵ0-3 
   33          bit updateperiod;             // ڱ־
   34          
   35          void main(void)
   36          {
   37   1        SYS_Ini();                  // STC32ʼ
   38   1        PWM_Config();               // PWMʼ
   39   1        Timer0_Init();              // ʱ0ʼ
   40   1        EA = 1;                     // ʹEAж
   41   1        MAX7219_Ini();              // MAX7219ʼ
   42   1        SEG_Disp();                 // ʾ
   43   1        period = PWMB_PERIOD_500;   // ʼPWMƵ500Hz
   44   1        
   45   1        while (1)
   46   1        {
   47   2          if(segdelay == 200)   // ÿ200ˢһ
   48   2          {
   49   3            freq = (MAIN_Fosc / cap) + 1;   // Ƶ
   50   3            SEG_Disp();           // ˢ
   51   3            segdelay = 0;
   52   3          }
   53   2        }
   54   1      }
   55          void SYS_Ini()                // STC32ʼ
   56          {
   57   1        EAXFR = 1;                  // ʹܷ XFR
   58   1        CKCON = 0x00;               // ⲿٶΪ
C251 COMPILER V5.57.0,  main                                                               15/03/23  21:09:12  PAGE 2   

   59   1        WTST = 0x00;                // óȴֵΪ 0 ɽ CPU ִгٶΪ
   60   1        
   61   1        P0M1 = 0x00;P0M0 = 0x00;    // P0Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   62   1        P1M1 = 0xFF;P1M0 = 0x00;    // P1Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   63   1        P2M1 = 0x00;P2M0 = 0x00;    // P2Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   64   1        P3M1 = 0x00;P3M0 = 0x00;    // P3Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   65   1        P4M1 = 0x00;P4M0 = 0x00;    // P4Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   66   1        P5M1 = 0x00;P5M0 = 0x00;    // P5Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   67   1        P6M1 = 0x00;P6M0 = 0x00;    // P6Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   68   1        P7M1 = 0x00;P7M0 = 0x00;    // P7Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   69   1      }
   70          void PWM_ISR() interrupt 26
   71          {
   72   1        if (PWMA_SR1 & 0X02)        // жϱ־1
   73   1        { 
   74   2          PWMA_SR1 &= ~0X02;        // 㲶жϱ־
   75   2          cap =(PWMA_CCR1H << 8) + PWMA_CCR1L;  // ȡֵ
   76   2        }
   77   1      }
   78          void PWM_Config()             // PWMʼ
   79          {
   80   1      //--------------------------PWMA-½---------------------------------- 
   81   1        PWMA_ENO = 0x00;            // رղ/ͨ
   82   1        PWMA_CCER1 = 0x00;          // رͨ
   83   1        PWMA_CCMR1 = 0x01;          // ͨģʽΪ
   84   1        PWMA_SMCR = 0x54;           // 1λģʽ
   85   1        PWMA_CCER1 = 0x01;          // ʹܲ/Ƚͨ1
   86   1      //  PWMA_CCER1 |= 0x00;         // ò/Ƚͨ1ز
   87   1        PWMA_CCER1 |= 0x20;         // ò/Ƚͨ1½ز
   88   1      
   89   1        PWMA_IER = 0x02;            // ʹܲж
   90   1        PWMA_CR1 |= 0x01;         // ʹPWMA
   91   1        
   92   1      //------------PWMB-PWM5(P2.0)һ·PWM500Hz-5KHzռձȣ50%-------------------
   93   1        PWMB_PSCRH = (u16)(PWMB_PSC >> 8);
   94   1        PWMB_PSCRL = (u16)(PWMB_PSC); // ԤƵ
   95   1        
   96   1        PWMB_CCER1 = 0x00;          // رͨ
   97   1        PWMB_CCMR1 = 0x68;          // ͨģʽΪPWMģʽ1
   98   1        PWMB_CCER1 = 0x05;          // ʹܲ/Ƚͨ5ʹCCRԤװ
   99   1      
  100   1        PWMB_CCR5H = (u16)(PWMB_PERIOD_500 >> 1 >> 8);
  101   1        PWMB_CCR5L = (u16)(PWMB_PERIOD_500 >> 1); // ռձ50%
  102   1        
  103   1        PWMB_ARRH = (u16)(PWMB_PERIOD_500 >> 8);
  104   1        PWMB_ARRL = (u16)(PWMB_PERIOD_500); // 
  105   1        
  106   1        PWMB_ENO = 0x01;            // ʹPWM5
  107   1        PWMB_BKR = 0x80;            // ʹPWMB
  108   1        PWMB_CR1 |= 0x01;           // ʹPWMB
  109   1      }
  110          void Timer0_Isr(void) interrupt 1
  111          {
  112   1        B_1ms = 1;                  // 1뵽
  113   1        segdelay++;
  114   1        keyscan();
  115   1        if(updateperiod == 1)       // ڱ־1ʱ
  116   1        {
C251 COMPILER V5.57.0,  main                                                               15/03/23  21:09:12  PAGE 3   

  117   2          PWMB_ARRH = (u16)(period >> 8);
  118   2          PWMB_ARRL = (u16)(period);        // 
  119   2          PWMB_CCR5H = (u16)(period >> 1 >> 8);
  120   2          PWMB_CCR5L = (u16)(period >> 1);  // ռձ
  121   2          updateperiod = 0;         // ڱ־
  122   2        }
  123   1      }
  124          void Timer0_Init(void)        //1@12.000MHz
  125          {
  126   1        AUXR |= 0x80;               //ʱʱ1Tģʽ
  127   1        TMOD &= 0xF0;               //öʱģʽ
  128   1        TL0 = 0x20;                 //öʱʼֵ
  129   1        TH0 = 0xD1;                 //öʱʼֵ
  130   1        TF0 = 0;                    //TF0־
  131   1        TR0 = 1;                    //ʱ0ʼ
  132   1        ET0 = 1;                    //ʹܶʱ0ж
  133   1      }
  134          void keyscan()
  135          {
  136   1      //--------------------KEY1--------------------------------------------------------------
  137   1        if(KEY1 == 0)               // 1
  138   1        {
  139   2          if(B_1ms == 1)            // 1뵽
  140   2          {
  141   3            key1delay++;            // 1ʱ+1
  142   3            B_1ms = 0;              // 㰴1ʱ
  143   3          }
  144   2          if(KEY1 == 0 && key1delay == 10)  // 1£ʱ10뵽
  145   2          {
  146   3            if(number > 0) number -= 1;     // number-1numberӦ4Ƶʣ500Hz1K2K5K
  147   3            updateperiod = 1;               // ڱ־1
  148   3          }
  149   2        }
  150   1        if(KEY1 == 1) key1delay = 0;        // ɿ㰴1ʱ
  151   1      //--------------------KEY2---------------------------------------------------------------
  152   1        if(KEY2 == 0)               // 2
  153   1        {
  154   2          if(B_1ms == 1)            // 1뵽
  155   2          {
  156   3            key2delay++;            // 2ʱ+1
  157   3            B_1ms = 0;              // 㰴2ʱ
  158   3          }
  159   2          if(KEY2 == 0 && key2delay == 10)  // 1£ʱ10뵽
  160   2          {
  161   3            if(number < 3) number += 1;     // number+1numberӦ4Ƶʣ500Hz1K2K5K
  162   3            updateperiod = 1;               // ڱ־1
  163   3          }
  164   2        }
  165   1        if(KEY2 == 1) key2delay = 0;        // ɿ2㰴2ʱ
  166   1        switch(number)                      
  167   1        {
  168   2          case 0:period = PWMB_PERIOD_500;break;  // number = 0: 500Hz
  169   2          case 1:period = PWMB_PERIOD_1K;break;   // number = 1: 1KHz
  170   2          case 2:period = PWMB_PERIOD_2K;break;   // number = 2: 2KHz
  171   2          case 3:period = PWMB_PERIOD_5K;break;   // number = 3: 5KHz
  172   2          default:break;
  173   2        }
  174   1      }
  175          void SEG_Disp(void)           // MAX7219ʾ                
  176          {             
  177   1        Write7219(8,15);            // 1λϨ
  178   1        Write7219(7,15);            // 2λϨ
  179   1        Write7219(6,15);            // 3λϨ
  180   1        Write7219(5,15);            // 4λϨ
  181   1        Write7219(4,(u16)((freq / 1000)%10));   // 5λʾǧλ
  182   1        Write7219(3,(u16)((freq / 100)%10));    // 6λʾλ
C251 COMPILER V5.57.0,  main                                                               15/03/23  21:09:12  PAGE 4   

  183   1        Write7219(2,(u16)((freq / 10)%10));     // 7λʾʮλ
  184   1        Write7219(1,(u16)(freq % 10));          // 8λʾλ
  185   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       823     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        12     ------
  bit size             =         2     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
