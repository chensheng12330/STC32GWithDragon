C251 COMPILER V5.57.0,  main                                                               06/04/23  19:35:15  PAGE 1   


C251 COMPILER V5.57.0, COMPILATION OF MODULE main
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\SoftWare\KeilC251\C251\BIN\C251.EXE main.c XSMALL BROWSE DEBUG PRINT(.\Listings\main.lst) TABS(2
                    -) OBJECT(.\Objects\main.obj) 

stmt  level    source

    1          //  @ٳ 2023/03/13
    2          //  PWM벶ʾPWM1P(P1.0)صһΣ㷽ƵʣMAX7219ʾ
    3          //  PWM5(P2.0)Ĭ500Hz ռձ50%
    4          //  MAX7219ģŶ壺CS = P6^5;DIN = P6^6;CLK = P6^4;MAX7219.h޸ģ
    5          //  ʵ鿪壺.1 @Ƶ12MHz
    6          
    7          #include "stc32g.h"
    8          #include "config.h"
    9          #include "MAX7219.h"
   10          
   11          #define PWMB_PSC (12 - 1)     // 12Ƶʱ1us
   12          #define PWMB_PERIOD_500 2000  // 2룬500Hz
   13          
   14          void SYS_Ini();               // STC32ʼ
   15          void SEG_Disp(void);          // ʾ
   16          void PWM_Config();            // PWMʼ
   17          void Timer0_Init(void);       // ʱ0ʼ
   18          
   19          int cap;                      // ֵ
   20          long int cap_new;             // ǰֵ
   21          int cap_old;                  // ϴβֵ
   22          u16 updateseg;                // ܱ־
   23          long int freq;                // Ƶ
   24          u8 segdelay;                  // ʱ
   25          bit B_1ms;                    // 1msʱ־
   26          u8 capnums;                   //  
   27          
   28          void main(void)
   29          {
   30   1        SYS_Ini();                  // STC32ʼ
   31   1        PWM_Config();               // PWMʼ
   32   1        Timer0_Init();              // ʱ0ʼ
   33   1        EA = 1;                     // ʹEAж
   34   1        MAX7219_Ini();              // MAX7219ʼ
   35   1        SEG_Disp();                 // ʾ
   36   1      
   37   1        while (1)
   38   1        {
   39   2          if(B_1ms == 1)            // 1뵽
   40   2          {
   41   3            segdelay++;             // ʱ+1
   42   3            B_1ms = 0;              // 1־
   43   3            if(segdelay == 200)     // ÿ200ˢһ
   44   3            {
   45   4              freq = (u16)(MAIN_Fosc / cap) + 1;  // 㷽Ƶʣ˴+1Ϊ˼ϱС
   46   4              SEG_Disp();           // ˢ
   47   4              segdelay = 0;         // ʱ
   48   4            }
   49   3          }
   50   2        }
   51   1      }
   52          void SYS_Ini()                // STC32ʼ
   53          {
   54   1        EAXFR = 1;                  // ʹܷ XFR
   55   1        CKCON = 0x00;               // ⲿٶΪ
   56   1        WTST = 0x00;                // óȴֵΪ 0 ɽ CPU ִгٶΪ
   57   1        
   58   1        P0M1 = 0x00;P0M0 = 0x00;    // P0Ϊ׼˫ģʽ //00׼˫ 01 10 11©
C251 COMPILER V5.57.0,  main                                                               06/04/23  19:35:15  PAGE 2   

             -
   59   1        P1M1 = 0xFF;P1M0 = 0x00;    // P1Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   60   1        P2M1 = 0x00;P2M0 = 0x00;    // P2Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   61   1        P3M1 = 0x00;P3M0 = 0x00;    // P3Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   62   1        P4M1 = 0x00;P4M0 = 0x00;    // P4Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   63   1        P5M1 = 0x00;P5M0 = 0x00;    // P5Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   64   1        P6M1 = 0x00;P6M0 = 0x00;    // P6Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   65   1        P7M1 = 0x00;P7M0 = 0x00;    // P7Ϊ׼˫ģʽ //00׼˫ 01 10 11©
             -
   66   1      }
   67          void PWM_ISR() interrupt 26
   68          {
   69   1        if (PWMA_SR1 & 0X02)        // жϱ־1
   70   1        { 
   71   2          PWMA_SR1 &= ~0X02;        // 㲶жϱ־
   72   2          cap_old = cap_new;        // µǰֵ
   73   2          cap_new =(PWMA_CCR1H << 8) + PWMA_CCR1L;  // ȡֵ8λ,ϲcap_new
   74   2          cap = cap_new - cap_old;    // βֵ
   75   2          capnums++;
   76   2          if(capnums == 2) PWMA_CCER1 = 0x00; //رղ/Ƚͨ1
   77   2        }
   78   1      }
   79          void PWM_Config()             // PWMʼ
   80          {
   81   1      //--------------------------PWMA----------------------------------- 
   82   1        PWMA_ENO = 0x00;            // رղ/ͨ
   83   1        PWMA_CCER1 = 0x00;          // رͨ
   84   1        PWMA_CCMR1 = 0x01;          // ͨģʽΪ
   85   1        PWMA_SMCR = 0x56;           // 1ģʽ
   86   1        PWMA_CCER1 = 0x01;          // ʹܲ/Ƚͨ1
   87   1        PWMA_CCER1 |= 0x00;         // ò/Ƚͨ1ز
   88   1      //  PWMA_CCER1 |= 0x20;         // ò/Ƚͨ1½ز
   89   1        
   90   1        PWMA_IER = 0x02;            // ʹܲж
   91   1        PWMA_CR1 = 0x01;            // PWMAʱ
   92   1        
   93   1      //------------PWMB-PWM5(P2.0)һ·PWM500Hzռձȣ50%-------------------
   94   1        PWMB_PSCRH = (u16)(PWMB_PSC >> 8);
   95   1        PWMB_PSCRL = (u16)(PWMB_PSC); // ԤƵ
   96   1        
   97   1        PWMB_CCER1 = 0x00;          // رͨ
   98   1        PWMB_CCMR1 = 0x68;          // ͨģʽΪPWMģʽ1
   99   1        PWMB_CCER1 = 0x05;          // ʹܲ/Ƚͨ1ʹCCRԤװ
  100   1      
  101   1        PWMB_CCR5H = (u16)(PWMB_PERIOD_500 >> 2 >> 8);
  102   1        PWMB_CCR5L = (u16)(PWMB_PERIOD_500 >> 2); // ռձ50%
  103   1        
  104   1        PWMB_ARRH = (u16)(PWMB_PERIOD_500 >> 8);
  105   1        PWMB_ARRL = (u16)(PWMB_PERIOD_500); // 
  106   1        
  107   1        PWMB_ENO = 0x01;            // ʹPWM5
  108   1        PWMB_BKR = 0x80;            // ʹPWMB
  109   1        PWMB_CR1 |= 0x01;           // ʹPWMB
  110   1      }
  111          void Timer0_Isr(void) interrupt 1
  112          {
  113   1        B_1ms = 1;
  114   1      }
  115          void Timer0_Init(void)        //1@12.000MHz
  116          {
C251 COMPILER V5.57.0,  main                                                               06/04/23  19:35:15  PAGE 3   

  117   1        AUXR |= 0x80;               //ʱʱ1Tģʽ
  118   1        TMOD &= 0xF0;               //öʱģʽ
  119   1        TL0 = 0x20;                 //öʱʼֵ
  120   1        TH0 = 0xD1;                 //öʱʼֵ
  121   1        TF0 = 0;                    //TF0־
  122   1        TR0 = 1;                    //ʱ0ʼʱ
  123   1        ET0 = 1;                    //ʹܶʱ0ж
  124   1      }
  125          void SEG_Disp(void)                         // MAX7219ʾ                
  126          {             
  127   1        Write7219(8,15);                          // 1λϨ
  128   1        Write7219(7,15);                          // 2λϨ
  129   1        Write7219(6,15);                          // 3λϨ
  130   1        Write7219(5,15);                          // 4λϨ
  131   1        Write7219(4,(u16)((freq / 1000)%10));     // 5λʾƵǧλ
  132   1        Write7219(3,(u16)((freq / 100)%10));      // 6λʾƵʰλ
  133   1        Write7219(2,(u16)((freq / 10)%10));       // 7λʾƵʮλ
  134   1        Write7219(1,(u16)(freq % 10));            // 8λʾƵʸλ
  135   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       597     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        16     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
